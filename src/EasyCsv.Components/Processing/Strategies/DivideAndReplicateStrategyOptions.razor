@namespace EasyCsv.Components

@if (CsvProcessor == null)
{
    throw new ArgumentException("EasyCsv: Attempted to render strategy options not within CsvProcessingStepper", nameof(CsvProcessingStepper));
}
<StrategyItem DisplayName="Divide And Replicate" Description="@Description" BeforeCsvExample="_beforeExample" AfterCsvExample="_afterExample" ExampleOptions="_exampleOptions" AllowRun="AllowRun" StrategyPicked="DivideAndReplicate">
    <Options>
        <MudListItem>
            <MudTextField Disabled="context" Placeholder="Delimiter" Immediate="true" Variant="Variant.Outlined" @bind-Value="_delimiter"></MudTextField>
        </MudListItem>
    </Options>
</StrategyItem>

@code
{
    [CascadingParameter] public CsvProcessingStepper CsvProcessor { get; set; } = null!;
    [Parameter] public bool Immediate { get; set; } = true;
    private const string Description = "Splits the values in a column on a specified delimiter into parts and then creates a copy of the row for each part";

    private static Dictionary<string, string> _exampleOptions = new Dictionary<string, string>()
    {
        {"Delimiter", "-"}
    };
    private static Dictionary<string, string>[] _beforeExample =
    [
        new Dictionary<string, string>()
        {
            {"Column1", "value1"},
            {"ColumnToDivideAndReplicate", "value2-value3"},
        },
    ];
    private static Dictionary<string, string>[] _afterExample =
    [
        new Dictionary<string, string>()
        {
            {"Column1", "value1"},
            {"ColumnToDivideAndReplicate", "value2"},
        },
        new Dictionary<string, string>()
        {
            {"Column1", "value1"},
            {"ColumnToDivideAndReplicate", "value3"},
        }
    ];

    private bool AllowRun => !string.IsNullOrWhiteSpace(_delimiter);
    private string? _delimiter;
    private async Task DivideAndReplicate(string columnName)
    {
        if (!AllowRun) return;
        var splitParsingStrategy = new DivideAndReplicate(columnName, y => y?.ToString()?.Split(_delimiter).Cast<object?>().ToArray());
        _ = await CsvProcessor.PerformCsvStrategy(splitParsingStrategy);
    }
}
