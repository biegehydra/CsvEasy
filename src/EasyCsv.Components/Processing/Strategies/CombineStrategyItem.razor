@namespace EasyCsv.Components

@if (CsvProcessor == null || StrategyBucket == null)
{
    throw new ArgumentException("EasyCsv: Attempted to render strategy options not within CsvProcessingStepper", nameof(CsvProcessingStepper));
}
@if (CsvProcessor.CurrentState != null)
{
    <StrategyItem DisplayName="Combine" Description="Splits column on value" AllowRun="AllowRun" StrategyPicked="DivideAndReplicate">
        <Options>
            <MudListItem>
                <MudCheckBox Disabled="@context" Label="Remove Joined Columns" @bind-Value="_removeJoinedColumns"></MudCheckBox>
            </MudListItem>
            <MudListItem>
                <MudTextField Disabled="@context" Immediate="Immediate" Required="true" Placeholder="Delimiter" Variant="Variant.Outlined" @bind-Value="_delimiter"></MudTextField>
            </MudListItem>
            <MudListItem>
                <MudTextField Disabled="@context" Immediate="Immediate" Required="true" Placeholder="New Column Name" Variant="Variant.Outlined" @bind-Value="_newColumnName"></MudTextField>
            </MudListItem>
            <MudListItem>
                <ColumnNamesInput Disabled="context" @bind-SelectedValues="_columnsToJoin"></ColumnNamesInput>
            </MudListItem>
        </Options>
    </StrategyItem>
}

@code
{
    [CascadingParameter] public CsvProcessingStepper CsvProcessor { get; set; } = null!;
    [CascadingParameter] private StrategyBucket StrategyBucket { get; set; } = null!;
    [Parameter] public bool Immediate { get; set; } = true;

    private bool AllowRun => !string.IsNullOrEmpty(_delimiter) && !string.IsNullOrWhiteSpace(_newColumnName) && _columnsToJoin?.Length > 1;
    private string[]? _columnsToJoin { get; set; }
    private string? _newColumnName;
    private string? _delimiter;
    private bool _removeJoinedColumns;

    private bool _initialized = false;
    protected override void OnParametersSet()
    {
        if (StrategyBucket != null! && !_initialized)
        {
            _initialized = true;
            _columnsToJoin = [StrategyBucket.ColumnName];
        }
    }

    private async Task DivideAndReplicate(string columnName)
    {
        if (!AllowRun) return;
        var splitParsingStrategy = new JoinColumnsStrategy(_columnsToJoin!, _newColumnName!, _delimiter!, _removeJoinedColumns);
        _ = await CsvProcessor.PerformCsvStrategy(splitParsingStrategy);
    }
}
