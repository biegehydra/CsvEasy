@using EasyCsv.Core.Configuration
@using EasyCsv.Processing
@using CsvHelper.Configuration
@using System.Globalization
@page "/processing"

<CsvProcessingStepper @ref="_csvProcessor" EasyCsv="_easyCsv">
    <ProcessingOptions>
        <StringSplitStrategyOptions ></StringSplitStrategyOptions>
        <DivideAndReplicateStrategyOptions ></DivideAndReplicateStrategyOptions>
        <CombineStrategyItem ></CombineStrategyItem>
        <StrategyItem DisplayName="Tag Invalid Email" StrategyPicked="OnTagPicked" />
    </ProcessingOptions>
</CsvProcessingStepper>
@code {
    [Parameter] public ISnackbar? Snackbar { get; set; }
    private CsvProcessingStepper _csvProcessor = null!;
    private readonly IEasyCsv? _easyCsv = EasyCsvFactory.FromFile("C:\\Users\\sweed\\Downloads\\keydatashorted.csv", int.MaxValue, Config);
    private string _tagToAdd;
    private async Task OnTagPicked(string columnName)
    {
        var addTagStrategy = new TagRowsStrategy((row, tags) =>
        {
            string? rowStr = row[columnName]?.ToString();
            if (!string.IsNullOrWhiteSpace(rowStr) && rowStr.Contains("@") == false)
            {
                tags.Add("Invalid Email");
            }
        });
        await _csvProcessor.PerformCsvStrategy(addTagStrategy);
    }

    private static EasyCsvConfiguration Config = new EasyCsvConfiguration()
    {
        CsvHelperConfig = new CsvConfiguration(CultureInfo.CurrentCulture),
        GiveEmptyHeadersNames = true
    };

}
