@using EasyCsv.Core.Configuration
@using CsvHelper.Configuration
@using System.Globalization
@using EasyCsv.Processing.Strategies
@page "/processing"
<style>
    @@media (min-width: 1280px) {
        .mud-container.mud-container-maxwidth-lg {
            max-width: 1600px;
        }
    }
</style>

<CsvProcessingStepper @ref="_csvProcessor" EasyCsvFileName="AppendJob.csv" EasyCsv="_easyCsv">
    <ColumnStrategies>
        <FindDedupesExactMatchColumn />
        <StringSplitColumn />
        <DivideAndReplicate />
        <TagAndReferenceMatches />
        <DeleteOnEmptyColumn />
        <StrategyItem DisplayName="Tag Invalid Email" DescriptionStr="Tag all rows with an invalid email on specified column"
                      BeforeCsvExample="_beforeExample" AfterCsvExample="_afterExample" StrategyPicked="OnTagPicked"/>
    </ColumnStrategies>
    <FullCsvStrategies>
        <AddCsv  />
        <CombineColumns  />
    </FullCsvStrategies>
</CsvProcessingStepper>
@code {
    [Parameter] public ISnackbar? Snackbar { get; set; }
    private CsvProcessingStepper _csvProcessor = null!;
    private readonly IEasyCsv _easyCsv = EasyCsvFactory.FromFile("C:\\Users\\sweed\\Downloads\\AppendJob.csv", int.MaxValue, Config);
    private static readonly Dictionary<string, string>[] _beforeExample =
    [
        new Dictionary<string, string>()
        {
            {"Email", "not an email"},
        },
        new Dictionary<string, string>()
        {
            {"Email", "real-email@test.com"},
        }
    ];
    private static readonly Dictionary<string, string>[] _afterExample =
    [
        new Dictionary<string, string>()
        {
            {"Email", "not an email"},
            {InternalColumnNames.Tags, "Invalid Email"},
        },
        new Dictionary<string, string>()
        {
            {"Email", "real-email@test.com"},
            {InternalColumnNames.Tags, ""},
        }
    ];
    private async Task OnTagPicked(string columnName)
    {
        var addTagStrategy = new TagRowsStrategy((row, tags) =>
        {
            string? rowStr = row[columnName]?.ToString();
            if (!string.IsNullOrWhiteSpace(rowStr) && rowStr.Contains("@") == false)
            {
                tags.Add("Invalid Email");
            }
        });
        await _csvProcessor.PerformCsvStrategy(addTagStrategy);
    }

    private static EasyCsvConfiguration Config = new EasyCsvConfiguration()
    {
        CsvHelperConfig = new CsvConfiguration(CultureInfo.CurrentCulture),
        GiveEmptyHeadersNames = true
    };

}
